# è¿ç»­åœç•™æ—¶é—´Bugä¿®å¤è¯´æ˜ ğŸ›

## ä¿®å¤æ—¥æœŸ
2024-01-XX

## å‘ç°çš„Bug

### Bug 1: è®¡ç®—é€»è¾‘ä¸å®Œæ•´
**é—®é¢˜**ï¼šåŸæ¥çš„é€»è¾‘åªæŸ¥è¯¢åŒä¸€åº”ç”¨çš„å†å²è®°å½•ï¼Œæ²¡æœ‰æ­£ç¡®æ£€æµ‹å…¶ä»–åº”ç”¨è·å¾—ç„¦ç‚¹çš„æƒ…å†µã€‚

**åœºæ™¯**ï¼š
```
10:00 Chrome èšç„¦
10:05 Chrome èšç„¦
10:10 VSCode èšç„¦ â† å…¶ä»–åº”ç”¨è·å¾—ç„¦ç‚¹
10:15 Chrome èšç„¦ â† åˆ‡å›æ¥
```

**Bugè¡¨ç°**ï¼šæ˜¾ç¤ºä»10:00å¼€å§‹çš„æ—¶é—´ï¼ˆ15åˆ†é’Ÿï¼‰ï¼Œè€Œä¸æ˜¯ä»10:15å¼€å§‹ï¼ˆæ­£ç¡®åº”è¯¥æ˜¯0ç§’ï¼‰

### Bug 2: æ ¼å¼åŒ–å‡½æ•°é”™è¯¯
**é—®é¢˜**ï¼šä½¿ç”¨äº† `formatUptime()` å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸æ˜¾ç¤ºç§’æ•°ã€‚

**Bugè¡¨ç°**ï¼šæ˜¾ç¤º"5åˆ†é’Ÿ"è€Œä¸æ˜¯"5åˆ†é’Ÿ 30ç§’"

### Bug 3: æ—¶é—´è®¡ç®—åœ¨å‰ç«¯
**é—®é¢˜**ï¼šéƒ¨åˆ†æ ¼å¼åŒ–é€»è¾‘åœ¨å‰ç«¯JavaScriptä¸­ï¼Œä¸ç»Ÿä¸€ã€‚

**Bugè¡¨ç°**ï¼šPHPè¿”å›çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²è¢«å‰ç«¯è¦†ç›–

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. å®Œå…¨åœ¨PHPç«¯è®¡ç®—å’Œæ ¼å¼åŒ–

**ä¼˜ç‚¹**ï¼š
- âœ… ç»Ÿä¸€çš„è®¡ç®—é€»è¾‘
- âœ… å‡å°‘å‰ç«¯è®¡ç®—è´Ÿæ‹…
- âœ… æ ¼å¼åŒ–ä¸€è‡´æ€§
- âœ… æ›´å®¹æ˜“è°ƒè¯•å’Œæµ‹è¯•

### 2. æ”¹è¿›çš„è®¡ç®—ç®—æ³•

#### æ­¥éª¤1ï¼šæŸ¥è¯¢å½“å‰åº”ç”¨çš„å†å²è®°å½•
```php
$appRecords = $db->fetchAll(
    'SELECT timestamp, is_focused 
     FROM process_records 
     WHERE device_id = ? 
       AND executable_name = ?
       AND timestamp <= ?
     ORDER BY timestamp DESC 
     LIMIT 100',
    [$deviceId, $currentAppName, $p['timestamp']]
);
```

#### æ­¥éª¤2ï¼šæ‰¾åˆ°éèšç„¦è®°å½•
```php
foreach ($appRecords as $record) {
    if ($record['is_focused'] == 0) {
        // æ‰¾åˆ°äº†ï¼è¿ç»­èšç„¦åœ¨è¿™ä¹‹åå¼€å§‹
        $consecutiveFocused = false;
        break;
    }
    $startTime = strtotime($record['timestamp']);
}
```

#### æ­¥éª¤3ï¼šæ£€æŸ¥å…¶ä»–åº”ç”¨æ˜¯å¦è·å¾—ç„¦ç‚¹
```php
if ($consecutiveFocused) {
    // æŸ¥è¯¢æ˜¯å¦æœ‰å…¶ä»–åº”ç”¨è·å¾—è¿‡ç„¦ç‚¹
    $otherFocusedApp = $db->fetchOne(
        'SELECT timestamp 
         FROM process_records 
         WHERE device_id = ? 
           AND executable_name != ?
           AND is_focused = 1
           AND timestamp > ?
           AND timestamp < ?
         ORDER BY timestamp DESC 
         LIMIT 1',
        [$deviceId, $currentAppName, ...]
    );
}
```

#### æ­¥éª¤4ï¼šæ‰¾åˆ°é‡æ–°è·å¾—ç„¦ç‚¹çš„æ—¶é—´
```php
if ($otherFocusedApp) {
    $regainFocus = $db->fetchOne(
        'SELECT timestamp 
         FROM process_records 
         WHERE device_id = ? 
           AND executable_name = ?
           AND is_focused = 1
           AND timestamp > ?
           AND timestamp <= ?
         ORDER BY timestamp ASC 
         LIMIT 1',
        [...]
    );
}
```

#### æ­¥éª¤5ï¼šPHPç«¯æ ¼å¼åŒ–
```php
$hours = floor($focusedDuration / 3600);
$minutes = floor(($focusedDuration % 3600) / 60);
$seconds = $focusedDuration % 60;

$parts = [];
if ($hours > 0) $parts[] = $hours . 'å°æ—¶';
if ($minutes > 0) $parts[] = $minutes . 'åˆ†é’Ÿ';
$parts[] = $seconds . 'ç§’';

$focusedDurationFormatted = implode(' ', $parts);
```

---

## ä¿®å¤åçš„è¡Œä¸º

### åœºæ™¯1ï¼šè¿ç»­ä½¿ç”¨ï¼ˆæ— åˆ‡æ¢ï¼‰
```
æ•°æ®ï¼š
10:00 Chrome is_focused=1
10:05 Chrome is_focused=1
10:10 Chrome is_focused=1 (å½“å‰)

è®¡ç®—ï¼š
1. æŸ¥è¯¢Chromeçš„å†å² â†’ éƒ½æ˜¯is_focused=1
2. æŸ¥è¯¢å…¶ä»–åº”ç”¨ â†’ æ²¡æœ‰å…¶ä»–åº”ç”¨è·å¾—ç„¦ç‚¹
3. èµ·å§‹æ—¶é—´ï¼š10:00
4. è¿ç»­åœç•™ï¼š10åˆ†é’Ÿ 0ç§’ âœ“
```

### åœºæ™¯2ï¼šä¸­é€”åˆ‡æ¢å…¶ä»–åº”ç”¨
```
æ•°æ®ï¼š
10:00 Chrome is_focused=1
10:05 Chrome is_focused=1
10:10 VSCode is_focused=1 â† å…¶ä»–åº”ç”¨è·å¾—ç„¦ç‚¹
10:15 Chrome is_focused=1 â† åˆ‡å›æ¥
10:20 Chrome is_focused=1 (å½“å‰)

è®¡ç®—ï¼š
1. æŸ¥è¯¢Chromeçš„å†å² â†’ éƒ½æ˜¯is_focused=1
2. æŸ¥è¯¢å…¶ä»–åº”ç”¨ â†’ 10:10æœ‰VSCodeè·å¾—ç„¦ç‚¹
3. æŸ¥è¯¢Chromeé‡æ–°è·å¾—ç„¦ç‚¹ â†’ 10:15
4. èµ·å§‹æ—¶é—´ï¼š10:15
5. è¿ç»­åœç•™ï¼š5åˆ†é’Ÿ 0ç§’ âœ“
```

### åœºæ™¯3ï¼šåº”ç”¨å¤±å»ç„¦ç‚¹åæ¢å¤
```
æ•°æ®ï¼š
10:00 Chrome is_focused=1
10:05 Chrome is_focused=1
10:10 Chrome is_focused=0 â† å¤±å»ç„¦ç‚¹
10:15 Chrome is_focused=1 â† æ¢å¤ç„¦ç‚¹
10:20 Chrome is_focused=1 (å½“å‰)

è®¡ç®—ï¼š
1. æŸ¥è¯¢Chromeçš„å†å² â†’ 10:10æ˜¯is_focused=0
2. åœ¨10:10å¤„åœæ­¢å›æº¯
3. èµ·å§‹æ—¶é—´ï¼š10:15ï¼ˆä¸‹ä¸€æ¡is_focused=1çš„è®°å½•ï¼‰
4. è¿ç»­åœç•™ï¼š5åˆ†é’Ÿ 0ç§’ âœ“
```

---

## APIå“åº”æ ¼å¼

### ä¿®å¤å‰
```json
{
  "focused_duration": 300,
  "focused_duration_formatted": "5åˆ†é’Ÿ"  // ç¼ºå°‘ç§’æ•°
}
```

### ä¿®å¤å
```json
{
  "focused_duration": 325,
  "focused_duration_formatted": "5åˆ†é’Ÿ 25ç§’"  // åŒ…å«ç§’æ•°
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢é™åˆ¶
- æ¯ä¸ªåº”ç”¨æœ€å¤šæŸ¥è¯¢100æ¡å†å²è®°å½•
- ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦
- åªåœ¨éœ€è¦æ—¶æŸ¥è¯¢å…¶ä»–åº”ç”¨

### æŸ¥è¯¢æ¬¡æ•°
```
æœ€å°‘ï¼š1æ¬¡ï¼ˆåªæŸ¥å½“å‰åº”ç”¨å†å²ï¼‰
æœ€å¤šï¼š3æ¬¡ï¼ˆå½“å‰åº”ç”¨ + å…¶ä»–åº”ç”¨ + é‡æ–°è·å¾—ç„¦ç‚¹ï¼‰
å¹³å‡ï¼š1-2æ¬¡
```

### æ—¶é—´å¤æ‚åº¦
- æŸ¥è¯¢ï¼šO(log n) - æ•°æ®åº“ç´¢å¼•æŸ¥è¯¢
- éå†ï¼šO(100) - æœ€å¤š100æ¡è®°å½•
- æ€»ä½“ï¼šO(log n + 100) â‰ˆ O(log n)

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1ï¼šåŸºæœ¬åŠŸèƒ½
```sql
-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO process_records (device_id, timestamp, executable_name, is_focused) VALUES
(1, '2024-01-01 10:00:00', 'chrome.exe', 1),
(1, '2024-01-01 10:05:00', 'chrome.exe', 1),
(1, '2024-01-01 10:10:00', 'chrome.exe', 1);

-- é¢„æœŸç»“æœï¼š10åˆ†é’Ÿ 0ç§’
```

### æµ‹è¯•2ï¼šåˆ‡æ¢åº”ç”¨
```sql
INSERT INTO process_records (device_id, timestamp, executable_name, is_focused) VALUES
(1, '2024-01-01 10:00:00', 'chrome.exe', 1),
(1, '2024-01-01 10:05:00', 'chrome.exe', 1),
(1, '2024-01-01 10:10:00', 'vscode.exe', 1),
(1, '2024-01-01 10:15:00', 'chrome.exe', 1),
(1, '2024-01-01 10:20:00', 'chrome.exe', 1);

-- é¢„æœŸç»“æœï¼š5åˆ†é’Ÿ 0ç§’ï¼ˆä»10:15å¼€å§‹ï¼‰
```

### æµ‹è¯•3ï¼šå¤±å»ç„¦ç‚¹
```sql
INSERT INTO process_records (device_id, timestamp, executable_name, is_focused) VALUES
(1, '2024-01-01 10:00:00', 'chrome.exe', 1),
(1, '2024-01-01 10:05:00', 'chrome.exe', 1),
(1, '2024-01-01 10:10:00', 'chrome.exe', 0),
(1, '2024-01-01 10:15:00', 'chrome.exe', 1),
(1, '2024-01-01 10:20:00', 'chrome.exe', 1);

-- é¢„æœŸç»“æœï¼š5åˆ†é’Ÿ 0ç§’ï¼ˆä»10:15å¼€å§‹ï¼‰
```

---

## å‰åç«¯èŒè´£

### PHPåç«¯ï¼ˆstats.phpï¼‰
âœ… æŸ¥è¯¢æ•°æ®åº“
âœ… è®¡ç®—è¿ç»­åœç•™æ—¶é—´
âœ… æ ¼å¼åŒ–æ—¶é—´å­—ç¬¦ä¸²
âœ… è¿”å›JSONæ•°æ®

### JavaScriptå‰ç«¯ï¼ˆdevice.jsï¼‰
âœ… è°ƒç”¨API
âœ… æ¥æ”¶æ•°æ®
âœ… æ˜¾ç¤ºæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
âŒ ä¸å†è¿›è¡Œæ—¶é—´è®¡ç®—
âŒ ä¸å†è¿›è¡Œæ ¼å¼åŒ–

---

## è°ƒè¯•æ–¹æ³•

### 1. æŸ¥çœ‹APIå“åº”
```bash
curl "http://your-domain/client/api/stats.php?action=realtime&device_id=1"
```

### 2. ä½¿ç”¨æµ‹è¯•é¡µé¢
```
è®¿é—®: test_realtime.php
æŸ¥çœ‹: è¿ç»­åœç•™ç§’æ•° å’Œ æ ¼å¼åŒ–æ˜¾ç¤º
```

### 3. æŸ¥çœ‹æ•°æ®åº“
```sql
SELECT 
    timestamp,
    executable_name,
    is_focused,
    CASE WHEN is_focused = 1 THEN 'èšç„¦' ELSE 'æœªèšç„¦' END as status
FROM process_records
WHERE device_id = 1
ORDER BY timestamp DESC
LIMIT 50;
```

### 4. æµè§ˆå™¨æ§åˆ¶å°
```javascript
// æ‰“å¼€è®¾å¤‡è¯¦æƒ…é¡µé¢
// æŒ‰F12 â†’ Console
// æŸ¥çœ‹æ—¥å¿—ï¼š
"å®æ—¶æ•°æ®å“åº”:"
"èšç„¦çš„åº”ç”¨:"
```

---

## å·²çŸ¥é™åˆ¶

1. **æŸ¥è¯¢é™åˆ¶100æ¡**ï¼šå¦‚æœè¿ç»­èšç„¦è¶…è¿‡100æ¬¡è®°å½•ï¼Œå¯èƒ½ä¸å‡†ç¡®
2. **æ—¶é—´ç²¾åº¦**ï¼šä¾èµ–äºå®¢æˆ·ç«¯ä¸ŠæŠ¥é¢‘ç‡ï¼ˆé€šå¸¸10ç§’ï¼‰
3. **æ—¶åŒºé—®é¢˜**ï¼šä½¿ç”¨æœåŠ¡å™¨æ—¶åŒºè®¡ç®—

---

## æœªæ¥æ”¹è¿›

- [ ] æ·»åŠ ç¼“å­˜æœºåˆ¶ï¼Œå‡å°‘é‡å¤è®¡ç®—
- [ ] æ”¯æŒæ›´é•¿çš„å†å²æŸ¥è¯¢ï¼ˆ>100æ¡ï¼‰
- [ ] æ·»åŠ æ—¶é—´ç²¾åº¦é…ç½®é€‰é¡¹
- [ ] ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

---

## ç›¸å…³æ–‡ä»¶

- `client/api/stats.php` - ä¿®å¤åçš„è®¡ç®—é€»è¾‘
- `client/public/assets/js/device.js` - å‰ç«¯æ˜¾ç¤º
- `client/public/test_realtime.php` - æµ‹è¯•å·¥å…·

---

## æ€»ç»“

é€šè¿‡å°†æ‰€æœ‰è®¡ç®—å’Œæ ¼å¼åŒ–é€»è¾‘ç§»åˆ°PHPç«¯ï¼Œæˆ‘ä»¬ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. âœ… æ­£ç¡®æ£€æµ‹åº”ç”¨åˆ‡æ¢
2. âœ… ç²¾ç¡®æ˜¾ç¤ºç§’æ•°
3. âœ… ç»Ÿä¸€çš„è®¡ç®—é€»è¾‘
4. âœ… æ›´å¥½çš„å¯ç»´æŠ¤æ€§

ç°åœ¨è¿ç»­åœç•™æ—¶é—´èƒ½å¤Ÿå‡†ç¡®åæ˜ ç”¨æˆ·åœ¨å½“å‰åº”ç”¨ä¸Šçš„è¿ç»­ä¸“æ³¨æ—¶é—´ï¼

