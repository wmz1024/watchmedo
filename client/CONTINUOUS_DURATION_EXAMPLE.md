# 连续停留时间计算示例 📚

## 核心概念

**连续停留时间** = 从最后一次切换到当前应用开始，到现在的持续时间。

**关键特性**：如果中途切换到其他应用，再切回来时会重新计算，不累计之前的时间。

---

## 详细示例

### 示例 1: 连续工作（无切换）

#### 数据记录
```
时间      应用        is_focused
------    ---------   ----------
10:00     Chrome      1
10:05     Chrome      1
10:10     Chrome      1
10:15     Chrome      1
10:20     Chrome      1  ← 当前
```

#### 计算过程
1. 当前聚焦：Chrome
2. 向前回溯，都是Chrome且is_focused=1
3. 找到最早的Chrome聚焦记录：10:00
4. **连续停留时间 = 10:20 - 10:00 = 20分钟**

#### 结果显示
```
🕐 连续停留: 20分钟
   未切换其他应用的持续时间
```

---

### 示例 2: 中途切换其他应用

#### 数据记录
```
时间      应用        is_focused
------    ---------   ----------
10:00     Chrome      1
10:05     Chrome      1
10:10     VSCode      1  ← 切换到VSCode
10:12     VSCode      1
10:15     Chrome      1  ← 切回Chrome
10:18     Chrome      1
10:20     Chrome      1  ← 当前
```

#### 计算过程
1. 当前聚焦：Chrome (10:20)
2. 向前回溯：
   - 10:18 Chrome is_focused=1 ✓ 继续
   - 10:15 Chrome is_focused=1 ✓ 继续
   - 10:12 VSCode is_focused=1 ✗ **停止**（其他应用获得焦点）
3. 起始时间：10:15（从VSCode切回Chrome的时间）
4. **连续停留时间 = 10:20 - 10:15 = 5分钟**

#### 结果显示
```
🕐 连续停留: 5分钟 0秒
   未切换其他应用的持续时间 (精确到秒)
```

**说明**：虽然10:00-10:05使用了Chrome共5分钟，但因为10:10切换到了VSCode，所以连续时间从10:15重新开始计算。时间精确显示到秒。

---

### 示例 3: 失去焦点后恢复

#### 数据记录
```
时间      应用        is_focused
------    ---------   ----------
10:00     Chrome      1
10:05     Chrome      1
10:10     Chrome      0  ← 失去焦点（最小化/后台）
10:12     VSCode      1  ← 其他应用获得焦点
10:15     Chrome      1  ← 重新获得焦点
10:18     Chrome      1
10:20     Chrome      1  ← 当前
```

#### 计算过程
1. 当前聚焦：Chrome (10:20)
2. 向前回溯：
   - 10:18 Chrome is_focused=1 ✓ 继续
   - 10:15 Chrome is_focused=1 ✓ 继续
   - 10:12 VSCode is_focused=1 ✗ **停止**（其他应用获得焦点）
3. 起始时间：10:15
4. **连续停留时间 = 10:20 - 10:15 = 5分钟**

#### 结果显示
```
🕐 连续停留: 5分钟
   未切换其他应用的持续时间
```

---

### 示例 4: 快速切换

#### 数据记录（每30秒记录一次）
```
时间      应用        is_focused
------    ---------   ----------
10:00:00  Chrome      1
10:00:30  Chrome      1
10:01:00  VSCode      1  ← 切换
10:01:30  Chrome      1  ← 切回
10:02:00  Chrome      1
10:02:30  Chrome      1  ← 当前
```

#### 计算过程
1. 当前聚焦：Chrome (10:02:30)
2. 向前回溯：
   - 10:02:00 Chrome is_focused=1 ✓ 继续
   - 10:01:30 Chrome is_focused=1 ✓ 继续
   - 10:01:00 VSCode is_focused=1 ✗ **停止**
3. 起始时间：10:01:30
4. **连续停留时间 = 10:02:30 - 10:01:30 = 1分钟**

#### 结果显示
```
🕐 连续停留: 1分钟
   未切换其他应用的持续时间
```

**说明**：即使只切换了30秒到VSCode，连续时间也会重置。

---

### 示例 5: 同一应用多个窗口

#### 数据记录
```
时间      应用        窗口标题          is_focused
------    ---------   --------------    ----------
10:00     Chrome      Google            1
10:05     Chrome      Google            1
10:10     Chrome      GitHub            1  ← 切换标签/窗口
10:15     Chrome      GitHub            1
10:20     Chrome      GitHub            1  ← 当前
```

#### 计算过程
1. 当前聚焦：Chrome - GitHub (10:20)
2. 向前回溯（**按应用名称判断**）：
   - 10:15 Chrome is_focused=1 ✓ 继续
   - 10:10 Chrome is_focused=1 ✓ 继续
   - 10:05 Chrome is_focused=1 ✓ 继续
   - 10:00 Chrome is_focused=1 ✓ 继续
3. 起始时间：10:00
4. **连续停留时间 = 10:20 - 10:00 = 20分钟**

#### 结果显示
```
🕐 连续停留: 20分钟
   未切换其他应用的持续时间
```

**说明**：同一应用的不同窗口/标签之间切换不会重置连续时间。

---

### 示例 6: 多次切换往返

#### 数据记录
```
时间      应用        is_focused
------    ---------   ----------
10:00     Chrome      1
10:05     VSCode      1  ← 第1次切换
10:10     Chrome      1  ← 切回
10:15     VSCode      1  ← 第2次切换
10:20     Chrome      1  ← 切回
10:25     Chrome      1
10:30     Chrome      1  ← 当前
```

#### 计算过程
1. 当前聚焦：Chrome (10:30)
2. 向前回溯：
   - 10:25 Chrome is_focused=1 ✓ 继续
   - 10:20 Chrome is_focused=1 ✓ 继续
   - 10:15 VSCode is_focused=1 ✗ **停止**
3. 起始时间：10:20（最后一次切回Chrome）
4. **连续停留时间 = 10:30 - 10:20 = 10分钟**

#### 结果显示
```
🕐 连续停留: 10分钟
   未切换其他应用的持续时间
```

---

## 判断逻辑流程图

```
开始
  ↓
获取当前聚焦应用A和时间T
  ↓
查询最近100条所有应用记录
  ↓
从当前时间向前逐条检查
  ↓
  ├→ 记录是应用A且is_focused=1？
  │   ↓ 是
  │   更新起始时间 = 该记录时间
  │   继续检查上一条记录
  │   
  ├→ 记录是应用A且is_focused=0？
  │   ↓ 是
  │   停止回溯
  │   
  └→ 记录是其他应用且is_focused=1？
      ↓ 是
      停止回溯
  ↓
计算时间差 = T - 起始时间
  ↓
返回连续停留时间
```

---

## 与累计时间的对比

### 连续停留时间（当前实现）
```
10:00-10:10  Chrome (10分钟)
10:10-10:15  VSCode (5分钟)
10:15-10:20  Chrome (5分钟) ← 显示5分钟
```

### 累计停留时间（如果实现）
```
10:00-10:10  Chrome (10分钟)
10:10-10:15  VSCode (5分钟)
10:15-10:20  Chrome (5分钟) ← 会显示15分钟（10+5）
```

**区别**：连续时间只计算最近一次连续使用的时长，累计时间会把所有使用该应用的时间加起来。

---

## 实际应用场景

### 场景1：专注工作监控
```
用户想知道自己在当前任务上连续工作了多久
→ 连续停留时间能准确反映专注度
→ 中途休息或查看其他内容会重置计时
```

### 场景2：效率分析
```
用户在写代码，但频繁切换到浏览器查资料
→ 连续停留时间短，说明注意力分散
→ 帮助用户识别工作习惯
```

### 场景3：番茄工作法
```
用户使用番茄工作法（25分钟专注）
→ 连续停留时间可以验证是否真正专注了25分钟
→ 切换应用会打断计时
```

---

## SQL查询示例

查看某设备的应用切换历史：

```sql
SELECT 
    timestamp,
    executable_name,
    is_focused,
    CASE 
        WHEN is_focused = 1 THEN '聚焦'
        ELSE '未聚焦'
    END as status,
    LAG(executable_name) OVER (ORDER BY timestamp) as prev_app
FROM process_records
WHERE device_id = 1
ORDER BY timestamp DESC
LIMIT 20;
```

---

## 常见问题

### Q1: 为什么我的停留时间很短？
**A**: 如果你经常切换应用，连续时间会不断重置。这反映了你的实际工作模式。

### Q2: 同一应用的不同窗口算切换吗？
**A**: 不算。只要应用名称相同，就算连续使用。

### Q3: 最小化应用会重置时间吗？
**A**: 会的。最小化后is_focused=0，如果其他应用获得焦点，时间会重置。

### Q4: 能否同时显示连续时间和累计时间？
**A**: 当前版本只显示连续时间。如需累计时间，可以在"应用使用详情"板块中查看。

---

## 性能说明

- 查询限制：最多查询最近100条记录
- 时间复杂度：O(n)，其中n ≤ 100
- 查询频率：每10秒更新一次
- 数据库负载：轻量级，不会影响性能

---

## 调试技巧

### 查看原始数据
```sql
SELECT * FROM process_records 
WHERE device_id = 1 
ORDER BY timestamp DESC 
LIMIT 50;
```

### 模拟切换场景
```sql
-- 插入测试数据
INSERT INTO process_records (device_id, timestamp, executable_name, is_focused)
VALUES 
    (1, '2024-01-01 10:00:00', 'chrome.exe', 1),
    (1, '2024-01-01 10:05:00', 'chrome.exe', 1),
    (1, '2024-01-01 10:10:00', 'vscode.exe', 1),
    (1, '2024-01-01 10:15:00', 'chrome.exe', 1),
    (1, '2024-01-01 10:20:00', 'chrome.exe', 1);
```

---

## 总结

连续停留时间是一个真实反映用户专注度的指标：
- ✅ 准确：只计算连续使用时间
- ✅ 直观：清楚看到当前任务的投入时间
- ✅ 实用：帮助识别工作模式和专注度
- ✅ 实时：每10秒自动更新

通过这个功能，用户可以更好地了解自己的工作习惯，优化时间管理。

