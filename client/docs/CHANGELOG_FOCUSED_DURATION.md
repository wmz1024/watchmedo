# 停留时间功能更新日志

## 新增功能: 显示当前应用停留时间 ⏱️

### 更新日期
2024-01-XX

### 功能描述
在设备详情页面（device.php）的"正在使用的应用"板块中，新增显示当前聚焦应用的**连续停留时间**。

### 功能特点

1. **连续时间追踪**: 显示的是连续聚焦时间，中途切换其他应用会重新计算
2. **实时更新**: 每10秒自动更新停留时间
3. **智能检测**: 自动检测焦点切换，确保时间连续性
4. **精确显示**: 自动格式化为"X小时X分钟X秒"格式，精确到秒
5. **视觉优化**: 添加时钟图标和专门的停留时间展示区域

### 技术实现

#### 后端 (stats.php)
- 添加 `focused_duration` 字段：停留时间（秒）
- 添加 `focused_duration_formatted` 字段：格式化后的停留时间
- 通过查询历史记录计算连续聚焦时长

#### 前端 (device.js)
- 在聚焦应用卡片下方添加停留时间显示区域
- 显示时钟图标和格式化的时间
- 支持自动刷新

### 界面展示

```
┌─────────────────────────────────────┐
│ 🟢 正在使用的应用      10秒后刷新    │
├─────────────────────────────────────┤
│  💻  Chrome                          │
│      Google Chrome - GitHub          │
│      CPU: 5.2%  内存: 500 MB        │
├─────────────────────────────────────┤
│  🕐  连续停留: 5分钟 30秒            │
│      未切换其他应用的持续时间(精确到秒)│
└─────────────────────────────────────┘
```

### 使用场景

1. **工作时间追踪**: 了解在某个应用上花费了多长时间
2. **效率分析**: 识别是否过度停留在某些应用
3. **专注度监控**: 追踪连续专注时长

### API响应格式

```json
{
  "processes": [
    {
      "name": "chrome.exe",
      "window_title": "Google Chrome",
      "is_focused": true,
      "focused_duration": 300,
      "focused_duration_formatted": "5分钟"
    }
  ]
}
```

### 计算逻辑（连续停留时间）

1. 获取当前聚焦的应用（is_focused = 1）
2. 向前查找所有应用的历史记录（最多100条）
3. 检测焦点切换事件：
   - 同一应用变为非聚焦状态（is_focused = 0）
   - 其他应用获得焦点（is_focused = 1）
4. 从最近一次切换到当前应用的时间点开始计算
5. 如果一直连续聚焦，使用最早的聚焦时间

**重要**：中途切换到其他应用再切回来，时间会重新计算，不累计。

### 示例场景

#### 场景1：连续使用20分钟
```
10:00 - Chrome 聚焦
10:05 - Chrome 聚焦
10:10 - Chrome 聚焦
10:15 - Chrome 聚焦
10:20 - Chrome 聚焦（当前）

连续停留时间：20分钟
```

#### 场景2：中途切换
```
10:00 - Chrome 聚焦（使用5分钟）
10:05 - Chrome 聚焦
10:10 - VSCode 聚焦（切换到VSCode）
10:15 - Chrome 聚焦（切回Chrome）
10:20 - Chrome 聚焦（当前）

连续停留时间：5分钟（从10:15重新计算）
```

### 性能优化

- 查询限制在最近50条记录，避免性能问题
- 使用索引优化查询速度
- 缓存计算结果，每10秒更新一次

### 兼容性

- ✅ SQLite
- ✅ MySQL
- ✅ PostgreSQL
- ✅ 所有现代浏览器

### 测试方法

1. 访问测试页面: `test_realtime.php`
2. 查看API响应中的`focused_duration`字段
3. 在设备详情页面观察停留时间显示

### 已知问题

- 如果客户端上报间隔较长，停留时间会跳跃显示
- 首次聚焦应用时，如果历史记录不足，可能无法准确计算

### 未来改进

- [ ] 添加停留时间图表（显示一天内各应用的停留时间分布）
- [ ] 支持停留时间阈值提醒
- [ ] 添加停留时间统计报告
- [ ] 支持多窗口标题的区分

### 相关文件

- `client/api/stats.php` - API接口实现
- `client/public/device.php` - 页面HTML
- `client/public/assets/js/device.js` - 前端逻辑
- `client/public/test_realtime.php` - 测试工具
- `client/REALTIME_DEBUG.md` - 调试指南

### 反馈

如有问题或建议，请通过以下方式反馈：
- GitHub Issues: https://github.com/wmz1024/watchmedo/issues
- 查看调试文档: `REALTIME_DEBUG.md`

