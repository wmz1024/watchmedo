# 多时间维度查看功能 📅

## 功能概述

在设备详情页面支持按日、月、年三种时间维度查看设备使用情况，全面了解设备的使用模式。

## 功能特性

### 1. 三种视图模式 📊

#### 日视图（默认）
- **时间范围**: 选定的某一天（24小时）
- **图表显示**: 按小时统计（0:00 - 23:00）
- **适用场景**: 查看某天的详细使用情况

#### 月视图
- **时间范围**: 选定的某个月（整月）
- **图表显示**: 按日统计（1日 - 31日）
- **适用场景**: 查看某月的使用趋势

#### 年视图
- **时间范围**: 选定的某一年（全年）
- **图表显示**: 按月统计（1月 - 12月）
- **适用场景**: 查看全年的使用概况

### 2. 智能数据聚合 🎯

不同视图模式自动调整数据聚合方式：

| 视图模式 | X轴维度 | 数据点数 | 聚合粒度 |
|---------|---------|---------|---------|
| 日 | 小时 | 24 | 每小时统计 |
| 月 | 日期 | 28-31 | 每天统计 |
| 年 | 月份 | 12 | 每月统计 |

### 3. 全局数据刷新 🔄

切换视图或时间时，自动刷新：
- ✅ 应用使用时间分布（饼图）
- ✅ 时间维度统计（柱状图）
- ✅ 最常用时间段
- ✅ 应用详细列表
- ✅ 实时数据（正在聚焦的应用）
- ✅ 网络流量
- ✅ 电池信息

## 界面展示

### 导航栏控件

```
┌─────────────────────────────────────────────┐
│ ← 返回    设备详情                           │
│                                             │
│         [日] [月] [年]  [2024-01-15]  刷新  │
└─────────────────────────────────────────────┘
```

### 日视图
```
时间选择: [2024-01-15]
图表标题: "24小时使用时间"
X轴标签: 0:00, 1:00, 2:00, ..., 23:00
Y轴单位: 分钟
最常用: "最常用时间段" (9:00-10:00, 14:00-15:00...)
```

### 月视图
```
时间选择: [2024-01]
图表标题: "每日使用时间"
X轴标签: 1日, 2日, 3日, ..., 31日
Y轴单位: 小时/分钟
最常用: "使用最多的日期" (15日, 20日, 25日...)
```

### 年视图
```
时间选择: [2024]
图表标题: "月度使用时间"
X轴标签: 1月, 2月, 3月, ..., 12月
Y轴单位: 小时
最常用: "使用最多的月份" (1月, 3月, 6月...)
```

## 技术实现

### 前端 (device.js)

#### 1. 视图模式变量
```javascript
let currentViewMode = 'day'; // 'day', 'month', 'year'
```

#### 2. 视图切换
```javascript
function switchViewMode(mode) {
    currentViewMode = mode;
    // 更新UI
    // 切换选择器
    // 重新加载数据
}
```

#### 3. 日期选择器管理
```javascript
// 日视图: <input type="date">
// 月视图: <input type="month">
// 年视图: <select> (下拉选择年份)
```

### 后端 (stats.php + functions.php)

#### 1. 视图模式参数
```php
$viewMode = $_GET['view_mode'] ?? 'day';
```

#### 2. 日期范围计算
```php
function getDateRangeByViewMode($date, $viewMode) {
    switch ($viewMode) {
        case 'year':
            return ['2024-01-01 00:00:00', '2024-12-31 23:59:59'];
        case 'month':
            return ['2024-01-01 00:00:00', '2024-01-31 23:59:59'];
        case 'day':
            return ['2024-01-15 00:00:00', '2024-01-15 23:59:59'];
    }
}
```

#### 3. 数据聚合函数
```php
aggregateHourlyUsage()   // 按小时 (日视图)
aggregateDailyUsage()    // 按日 (月视图)
aggregateMonthlyUsage()  // 按月 (年视图)
```

## API数据格式

### 请求
```
GET /api/stats.php?action=device&device_id=1&date=2024-01-15&view_mode=day
GET /api/stats.php?action=device&device_id=1&date=2024-01&view_mode=month
GET /api/stats.php?action=device&device_id=1&date=2024&view_mode=year
```

### 响应
```json
{
  "success": true,
  "data": {
    "view_mode": "month",
    "date": "2024-01",
    "time_chart": {
      "data": [3600, 7200, ...],
      "labels": ["1日", "2日", "3日", ...]
    },
    "most_active_hours": [
      {
        "hour": 14,
        "period": 15,
        "seconds": 7200,
        "formatted": "2小时"
      }
    ]
  }
}
```

## 使用场景

### 场景1：查看今天的使用情况
```
1. 选择"日"视图
2. 选择今天的日期
3. 查看24小时使用分布
4. 发现：9-12点和14-18点是高峰期
```

### 场景2：分析本月使用趋势
```
1. 选择"月"视图
2. 选择当前月份
3. 查看每日使用情况
4. 发现：周一到周五使用时间长，周末较短
```

### 场景3：回顾全年工作模式
```
1. 选择"年"视图
2. 选择2024年
3. 查看12个月的使用对比
4. 发现：3月和9月项目高峰期，使用时间最长
```

## 图表对比

### 日视图图表
```
24小时使用时间
  分
  钟
  │     ▄
  │    ▄█▄
  │   ▄███▄     ▄▄
  │  ▄█████▄   ▄██▄
  └──────────────────
   0  6  12  18  24 时
```

### 月视图图表
```
每日使用时间
  小
  时
  │        ▄
  │   ▄   ▄█    ▄
  │  ▄█▄ ▄██▄  ▄█▄
  │ ▄███▄████▄▄███▄
  └──────────────────
   1  8  15  22  31 日
```

### 年视图图表
```
月度使用时间
  小
  时
  │     ▄▄
  │    ▄██▄     ▄
  │   ▄████▄   ▄█▄
  │  ▄██████▄ ▄███▄
  └──────────────────
   1  3  6  9  12 月
```

## 刷新机制

### 全局刷新触发条件

所有以下操作都会触发完整的数据刷新：

1. **点击刷新按钮**
   ```javascript
   loadDeviceData();      // 统计数据
   loadRealtimeData();    // 实时数据
   ```

2. **切换视图模式**
   ```javascript
   switchViewMode('month');
   → loadDeviceData();
   → loadRealtimeData();
   ```

3. **更改日期/月份/年份**
   ```javascript
   date-picker.change
   → loadDeviceData();
   → loadRealtimeData();
   ```

4. **自动刷新（实时数据）**
   ```javascript
   每10秒自动执行:
   → loadRealtimeData();
   ```

### 数据刷新清单

✅ 设备基本信息（名称、在线状态、最后上报）
✅ 系统资源（CPU、内存、运行时间）
✅ 电池信息（笔记本）
✅ 正在聚焦的应用
✅ 网络流量
✅ 应用使用时间分布（饼图）
✅ 时间维度统计（柱状图）
✅ 最常用时间段/日期/月份
✅ 应用详细列表

## 性能优化

### 1. 智能查询
```php
// 只查询需要的时间范围
WHERE timestamp >= ? AND timestamp <= ?
```

### 2. 索引优化
```sql
CREATE INDEX idx_device_timestamp ON process_records(device_id, timestamp);
```

### 3. 数据预聚合
```php
// 按需聚合，不重复计算
$timeData = array_fill(0, $count, 0);
```

### 4. 前端缓存
```javascript
// 视图模式和日期作为缓存key
// 避免重复请求相同数据
```

## 用户体验

### 1. 视觉反馈
- 当前视图按钮高亮（蓝色背景）
- 对应的选择器显示
- 其他选择器隐藏

### 2. 平滑过渡
- 切换视图时图表平滑更新
- 按钮状态即时反馈

### 3. 智能默认值
- 日视图：今天
- 月视图：本月
- 年视图：今年

## 数据示例

### 日视图数据
```
2024年1月15日
- 总使用时间: 8小时 30分钟
- 高峰时段: 9:00-12:00, 14:00-18:00
- Top应用: Chrome (3小时), VSCode (2小时)
```

### 月视图数据
```
2024年1月
- 总使用时间: 156小时 45分钟
- 使用最多: 15日 (10小时), 22日 (9小时)
- Top应用: Chrome (68小时), VSCode (45小时)
```

### 年视图数据
```
2024年
- 总使用时间: 1,850小时
- 使用最多: 3月 (180小时), 9月 (165小时)
- Top应用: Chrome (800小时), VSCode (520小时)
```

## 最常用时间段变化

### 日视图
```
最常用时间段:
1️⃣ 9:00 - 10:00    2小时
2️⃣ 14:00 - 15:00   1.8小时
3️⃣ 10:00 - 11:00   1.5小时
```

### 月视图
```
使用最多的日期:
1️⃣ 15日    10小时 30分钟
2️⃣ 22日    9小时 45分钟
3️⃣ 8日     8小时 20分钟
```

### 年视图
```
使用最多的月份:
1️⃣ 3月    180小时
2️⃣ 9月    165小时
3️⃣ 6月    152小时
```

## 技术细节

### SQL查询示例

#### 日视图（按小时）
```sql
SELECT 
    strftime('%H', timestamp) as hour,
    SUM(CASE WHEN is_focused = 1 THEN 1 ELSE 0 END) * 60 as total_seconds
FROM process_records
WHERE device_id = 1 
  AND timestamp >= '2024-01-15 00:00:00'
  AND timestamp <= '2024-01-15 23:59:59'
GROUP BY hour
ORDER BY hour;
```

#### 月视图（按日）
```sql
SELECT 
    strftime('%d', timestamp) as day,
    SUM(CASE WHEN is_focused = 1 THEN 1 ELSE 0 END) * 60 as total_seconds
FROM process_records
WHERE device_id = 1 
  AND timestamp >= '2024-01-01 00:00:00'
  AND timestamp <= '2024-01-31 23:59:59'
GROUP BY day
ORDER BY day;
```

#### 年视图（按月）
```sql
SELECT 
    strftime('%m', timestamp) as month,
    SUM(CASE WHEN is_focused = 1 THEN 1 ELSE 0 END) * 60 as total_seconds
FROM process_records
WHERE device_id = 1 
  AND timestamp >= '2024-01-01 00:00:00'
  AND timestamp <= '2024-12-31 23:59:59'
GROUP BY month
ORDER BY month;
```

## 相关文件

### 前端
- `client/public/device.php` - UI组件和选择器
- `client/public/assets/js/device.js` - 视图切换逻辑

### 后端
- `client/api/stats.php` - API接口
- `client/includes/functions.php` - 数据聚合函数
  - `getDateRangeByViewMode()` - 日期范围计算
  - `aggregateHourlyUsage()` - 按小时聚合
  - `aggregateDailyUsage()` - 按日聚合
  - `aggregateMonthlyUsage()` - 按月聚合

## 测试方法

### 测试1: 日视图
```
1. 选择"日"视图
2. 选择一个有数据的日期
3. 查看24小时分布图
4. 验证数据是否正确
```

### 测试2: 月视图
```
1. 选择"月"视图
2. 选择当前月份
3. 查看每日使用情况
4. 点击不同日期对比数据
```

### 测试3: 年视图
```
1. 选择"年"视图
2. 选择2024年
3. 查看12个月对比
4. 验证总使用时间
```

### 测试4: 切换刷新
```
1. 在日视图查看数据
2. 切换到月视图
3. 验证所有数据都刷新了
4. 点击刷新按钮
5. 验证实时数据也更新了
```

## 故障排查

### 问题1: 切换视图后图表不更新

**检查:**
```javascript
// 浏览器控制台
console.log('当前视图模式:', currentViewMode);
console.log('图表数据:', data.time_chart);
```

### 问题2: 月视图显示不全

**原因**: 月份天数不同（28-31天）
**解决**: 已自动适配，使用 `date('t')` 获取当月天数

### 问题3: 实时数据未刷新

**检查**: 确认所有事件监听器都调用了 `loadRealtimeData()`

```javascript
// 应该包含:
loadDeviceData();
loadRealtimeData();
```

## 未来改进

- [ ] 添加周视图（7天）
- [ ] 支持自定义时间范围
- [ ] 数据对比功能（对比不同时间段）
- [ ] 导出报表（PDF/Excel）
- [ ] 趋势分析（同比/环比）
- [ ] 预测功能（基于历史数据）

## 优势

### 1. 多维度分析 📊
- 短期分析：日视图看细节
- 中期分析：月视图看趋势
- 长期分析：年视图看全局

### 2. 灵活查询 🔍
- 可以查看任意历史日期
- 快速切换不同时间维度
- 一键刷新最新数据

### 3. 数据洞察 💡
- 识别工作模式
- 发现使用高峰
- 优化时间管理

## 总结

多时间维度查看功能让用户可以：

- ✅ **全面了解**: 从日到年，全方位掌握设备使用情况
- ✅ **灵活切换**: 一键切换视图，无缝查看不同维度
- ✅ **实时更新**: 所有数据同步刷新，保持一致性
- ✅ **智能聚合**: 自动选择合适的统计粒度
- ✅ **性能优化**: 高效的SQL查询和数据处理

现在用户可以轻松查看设备的日、月、年使用情况，全面掌握使用模式！📅✨

